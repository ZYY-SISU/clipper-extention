# åç«¯é…åˆéœ€æ±‚æ–‡æ¡£

## æ¦‚è¿°
å‰ç«¯å·²å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼Œéœ€è¦åç«¯åŒå­¦é…åˆå¤„ç†æ–°å¢çš„å­—æ®µï¼Œç¡®ä¿æ•°æ®èƒ½æ­£ç¡®å­˜å‚¨åˆ°é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­ã€‚

---

## ä¸€ã€æ–°å¢å­—æ®µè¯´æ˜

### 1. é«˜äº®ä¿¡æ¯ (highlights)
**å­—æ®µç±»å‹**: `Array<HighlightInfo>` (å¯é€‰)

**æ•°æ®ç»“æ„**:
```typescript
interface HighlightInfo {
  id: string;              // é«˜äº®å”¯ä¸€æ ‡è¯†
  text: string;            // é«˜äº®çš„æ–‡æœ¬å†…å®¹
  startOffset: number;     // èµ·å§‹åç§»é‡
  endOffset: number;       // ç»“æŸåç§»é‡
  startContainer: string;  // èµ·å§‹å®¹å™¨èŠ‚ç‚¹åç§°
  endContainer: string;    // ç»“æŸå®¹å™¨èŠ‚ç‚¹åç§°
}
```

**ä¸šåŠ¡éœ€æ±‚**:
- å‰ç«¯åœ¨å‰ªè—æ—¶ï¼Œå¦‚æœç”¨æˆ·å¯¹æ–‡æœ¬è¿›è¡Œäº†é«˜äº®æ“ä½œï¼Œä¼šå°†é«˜äº®ä¿¡æ¯ä¸€å¹¶ä¼ é€’
- **åç«¯éœ€è¦å°†é«˜äº®ä¿¡æ¯ä»¥æŸç§æ ¼å¼ä¿å­˜åˆ°é£ä¹¦è¡¨æ ¼ä¸­**ï¼Œç¡®ä¿åœ¨é£ä¹¦ä¸­ä¹Ÿèƒ½çœ‹åˆ°é«˜äº®æ ‡è®°
- å»ºè®®æ–¹æ¡ˆï¼š
  1. åœ¨é£ä¹¦è¡¨æ ¼ä¸­æ–°å¢ä¸€ä¸ª"é«˜äº®å†…å®¹"å­—æ®µï¼ˆæ–‡æœ¬ç±»å‹ï¼‰
  2. å°†å¤šä¸ªé«˜äº®æ–‡æœ¬ç”¨åˆ†éš”ç¬¦ï¼ˆå¦‚ `|||`ï¼‰è¿æ¥åå­˜å‚¨
  3. æˆ–è€…åœ¨"æ‘˜è¦"æˆ–"æ ‡é¢˜"å­—æ®µä¸­ä½¿ç”¨ Markdown é«˜äº®è¯­æ³• `==æ–‡æœ¬==` æ¥æ ‡è®°

**å‰ç«¯ä¼ é€’ç¤ºä¾‹**:
```json
{
  "title": "æ–‡ç« æ ‡é¢˜",
  "summary": "æ–‡ç« æ‘˜è¦",
  "highlights": [
    {
      "id": "sc-highlight-1",
      "text": "è¿™æ˜¯è¢«é«˜äº®çš„æ–‡æœ¬",
      "startOffset": 10,
      "endOffset": 20,
      "startContainer": "#text",
      "endContainer": "#text"
    }
  ]
}
```

---

### 2. å›¾ç‰‡ä¿¡æ¯ (images)
**å­—æ®µç±»å‹**: `Array<ImageData>` (å¯é€‰)

**æ•°æ®ç»“æ„**:
```typescript
interface ImageData {
  src: string;      // å›¾ç‰‡URL
  alt: string;      // å›¾ç‰‡æè¿°/æ›¿ä»£æ–‡æœ¬
  width?: number;   // å›¾ç‰‡å®½åº¦ï¼ˆå¯é€‰ï¼‰
  height?: number;  // å›¾ç‰‡é«˜åº¦ï¼ˆå¯é€‰ï¼‰
}
```

**ä¸šåŠ¡éœ€æ±‚**:
- å‰ç«¯åœ¨å‰ªè—æ—¶ä¼šæå–é¡µé¢ä¸­çš„å›¾ç‰‡ä¿¡æ¯
- **åç«¯éœ€è¦å°†å›¾ç‰‡ä¿¡æ¯ä¿å­˜åˆ°é£ä¹¦è¡¨æ ¼ä¸­**
- å»ºè®®æ–¹æ¡ˆï¼š
  1. åœ¨é£ä¹¦è¡¨æ ¼ä¸­æ–°å¢ä¸€ä¸ª"å›¾ç‰‡"å­—æ®µï¼ˆé™„ä»¶ç±»å‹æˆ–æ–‡æœ¬ç±»å‹ï¼‰
  2. å¦‚æœæ˜¯é™„ä»¶ç±»å‹ï¼šå¯ä»¥å°è¯•ä¸Šä¼ å›¾ç‰‡ï¼ˆéœ€è¦å¤„ç†è·¨åŸŸå’Œä¸‹è½½ï¼‰
  3. å¦‚æœæ˜¯æ–‡æœ¬ç±»å‹ï¼šå­˜å‚¨å›¾ç‰‡URLåˆ—è¡¨ï¼Œç”¨åˆ†éš”ç¬¦è¿æ¥ï¼ˆå¦‚ `|||`ï¼‰

**å‰ç«¯ä¼ é€’ç¤ºä¾‹**:
```json
{
  "title": "æ–‡ç« æ ‡é¢˜",
  "summary": "æ–‡ç« æ‘˜è¦",
  "images": [
    {
      "src": "https://example.com/image1.jpg",
      "alt": "å›¾ç‰‡æè¿°1",
      "width": 800,
      "height": 600
    },
    {
      "src": "https://example.com/image2.png",
      "alt": "å›¾ç‰‡æè¿°2"
    }
  ]
}
```

---

### 3. é“¾æ¥ä¿¡æ¯ (links)
**å­—æ®µç±»å‹**: `Array<LinkData>` (å¯é€‰)

**æ•°æ®ç»“æ„**:
```typescript
interface LinkData {
  href: string;  // é“¾æ¥URL
  text: string;  // é“¾æ¥æ–‡æœ¬
}
```

**ä¸šåŠ¡éœ€æ±‚**:
- å‰ç«¯åœ¨å‰ªè—æ—¶ä¼šæå–é¡µé¢ä¸­çš„é“¾æ¥ä¿¡æ¯
- **åç«¯éœ€è¦å°†é“¾æ¥ä¿¡æ¯ä¿å­˜åˆ°é£ä¹¦è¡¨æ ¼ä¸­**
- å»ºè®®æ–¹æ¡ˆï¼š
  1. åœ¨é£ä¹¦è¡¨æ ¼ä¸­æ–°å¢ä¸€ä¸ª"é“¾æ¥"å­—æ®µï¼ˆæ–‡æœ¬ç±»å‹æˆ–é“¾æ¥ç±»å‹ï¼‰
  2. å¦‚æœæ˜¯é“¾æ¥ç±»å‹ï¼šå¯ä»¥å­˜å‚¨ç¬¬ä¸€ä¸ªé“¾æ¥ï¼Œæˆ–è€…ç”¨åˆ†éš”ç¬¦è¿æ¥å¤šä¸ªé“¾æ¥
  3. å¦‚æœæ˜¯æ–‡æœ¬ç±»å‹ï¼šå­˜å‚¨é“¾æ¥URLåˆ—è¡¨ï¼Œç”¨åˆ†éš”ç¬¦è¿æ¥ï¼ˆå¦‚ `|||`ï¼‰

**å‰ç«¯ä¼ é€’ç¤ºä¾‹**:
```json
{
  "title": "æ–‡ç« æ ‡é¢˜",
  "summary": "æ–‡ç« æ‘˜è¦",
  "links": [
    {
      "href": "https://example.com/page1",
      "text": "ç›¸å…³é“¾æ¥1"
    },
    {
      "href": "https://example.com/page2",
      "text": "ç›¸å…³é“¾æ¥2"
    }
  ]
}
```

---

## äºŒã€API æ¥å£ä¿®æ”¹

### å½“å‰æ¥å£: `POST /api/save`

**å½“å‰è¯·æ±‚ä½“ç»“æ„**:
```typescript
{
  title: string;
  summary: string;
  tags: string[];
  sentiment: string;
  url: string;
  userAccessToken: string;
  appToken: string;
  tableId: string;
}
```

**éœ€è¦æ‰©å±•ä¸º**:
```typescript
{
  title: string;
  summary: string;
  tags: string[];
  sentiment: string;
  url: string;
  // ğŸ†• æ–°å¢å­—æ®µ
  images?: Array<ImageData>;
  links?: Array<LinkData>;
  highlights?: Array<HighlightInfo>;
  // åŸæœ‰å­—æ®µ
  userAccessToken: string;
  appToken: string;
  tableId: string;
}
```

---

## ä¸‰ã€åç«¯å®ç°å»ºè®®

### 1. ä¿®æ”¹ `smart-clipper-backend/src/index.ts`

åœ¨ `/api/save` æ¥å£ä¸­æ¥æ”¶æ–°å­—æ®µï¼š

```typescript
app.post('/api/save', async (req: Request, res: Response): Promise<void> => {
  try {
    const { 
      title, summary, tags, sentiment, url, // åŸæœ‰å­—æ®µ
      images, links, highlights,              // ğŸ†• æ–°å¢å­—æ®µ
      userAccessToken, appToken, tableId
    } = req.body;
    
    // ... æ ¡éªŒé€»è¾‘ ...
    
    // è°ƒç”¨æœåŠ¡ï¼Œä¼ é€’å®Œæ•´æ•°æ®
    await addRecord(
      { 
        title, summary, tags, sentiment, url,
        images, links, highlights  // ğŸ†• ä¼ é€’æ–°å­—æ®µ
      }, 
      { userAccessToken, appToken, tableId }
    );
    
    res.json({ success: true, message: 'å·²åŒæ­¥åˆ°æ‚¨çš„é£ä¹¦' });
  } catch (error: any) {
    // ... é”™è¯¯å¤„ç† ...
  }
});
```

---

### 2. ä¿®æ”¹ `smart-clipper-backend/src/services/feishuService.ts`

#### 2.1 æ›´æ–°ç±»å‹å®šä¹‰

åœ¨ `smart-clipper-backend/src/types/index.ts` ä¸­æ‰©å±• `FeishuData` æ¥å£ï¼š

```typescript
export interface FeishuData {
  title: string;
  summary: string;
  tags: string[];
  sentiment: string;
  url: string;
  // ğŸ†• æ–°å¢å­—æ®µ
  images?: Array<{
    src: string;
    alt: string;
    width?: number;
    height?: number;
  }>;
  links?: Array<{
    href: string;
    text: string;
  }>;
  highlights?: Array<{
    id: string;
    text: string;
    startOffset: number;
    endOffset: number;
    startContainer: string;
    endContainer: string;
  }>;
}
```

#### 2.2 ä¿®æ”¹ `addRecord` å‡½æ•°

åœ¨ç»„è£…é£ä¹¦å­—æ®µæ—¶ï¼Œå¤„ç†æ–°å­—æ®µï¼š

```typescript
export const addRecord = async (data: FeishuData, options: SaveOptions) => {
  // ... åŸæœ‰é€»è¾‘ ...
  
  // ç»„è£…æ•°æ®
  const fields: any = {
    "æ ‡é¢˜": data.title || "æ— æ ‡é¢˜",
    "æ‘˜è¦": data.summary || "æ— æ‘˜è¦",
    "æƒ…æ„Ÿ": data.sentiment || "ä¸­æ€§",
    "æ ‡ç­¾": Array.isArray(data.tags) ? data.tags.join(", ") : (data.tags || ""),
    "åŸæ–‡é“¾æ¥": { 
      text: "ç‚¹å‡»è®¿é—®", 
      link: data.url || "https://www.example.com"
    },
    // ğŸ†• å¤„ç†å›¾ç‰‡ä¿¡æ¯
    "å›¾ç‰‡": data.images && data.images.length > 0 
      ? data.images.map(img => img.src).join(" ||| ")  // ç”¨åˆ†éš”ç¬¦è¿æ¥
      : "",
    // ğŸ†• å¤„ç†é“¾æ¥ä¿¡æ¯
    "é“¾æ¥": data.links && data.links.length > 0
      ? data.links.map(link => `${link.text}: ${link.href}`).join(" ||| ")
      : "",
    // ğŸ†• å¤„ç†é«˜äº®ä¿¡æ¯
    "é«˜äº®å†…å®¹": data.highlights && data.highlights.length > 0
      ? data.highlights.map(h => h.text).join(" ||| ")
      : ""
  };
  
  // ... åç»­å†™å…¥é€»è¾‘ ...
};
```

**æ³¨æ„**: å¦‚æœé£ä¹¦è¡¨æ ¼ä¸­è¿˜æ²¡æœ‰è¿™äº›å­—æ®µï¼Œéœ€è¦ï¼š
1. åœ¨é£ä¹¦è¡¨æ ¼ä¸­æ‰‹åŠ¨æ·»åŠ "å›¾ç‰‡"ã€"é“¾æ¥"ã€"é«˜äº®å†…å®¹"å­—æ®µ
2. æˆ–è€…ä½¿ç”¨é£ä¹¦ API è‡ªåŠ¨åˆ›å»ºå­—æ®µï¼ˆéœ€è¦é¢å¤–å®ç°ï¼‰

---

## å››ã€é£ä¹¦è¡¨æ ¼å­—æ®µå»ºè®®

å»ºè®®åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µå | å­—æ®µç±»å‹ | è¯´æ˜ |
|--------|---------|------|
| æ ‡é¢˜ | æ–‡æœ¬ | å·²æœ‰ |
| æ‘˜è¦ | æ–‡æœ¬ | å·²æœ‰ |
| æ ‡ç­¾ | æ–‡æœ¬ | å·²æœ‰ |
| æƒ…æ„Ÿ | æ–‡æœ¬ | å·²æœ‰ |
| åŸæ–‡é“¾æ¥ | è¶…é“¾æ¥ | å·²æœ‰ |
| **å›¾ç‰‡** | **æ–‡æœ¬** | ğŸ†• å­˜å‚¨å›¾ç‰‡URLåˆ—è¡¨ |
| **é“¾æ¥** | **æ–‡æœ¬** | ğŸ†• å­˜å‚¨é“¾æ¥ä¿¡æ¯ |
| **é«˜äº®å†…å®¹** | **æ–‡æœ¬** | ğŸ†• å­˜å‚¨é«˜äº®æ–‡æœ¬ |

---

## äº”ã€æµ‹è¯•å»ºè®®

1. **æµ‹è¯•é«˜äº®ä¿¡æ¯ä¼ é€’**:
   - åœ¨å‰ç«¯é€‰ä¸­æ–‡æœ¬å¹¶ç‚¹å‡»"é«˜äº®"æŒ‰é’®
   - ç„¶åç‚¹å‡»"å‰ªè—"æŒ‰é’®
   - æ£€æŸ¥åç«¯æ¥æ”¶åˆ°çš„ `highlights` å­—æ®µæ˜¯å¦æ­£ç¡®

2. **æµ‹è¯•å›¾ç‰‡ä¿¡æ¯ä¼ é€’**:
   - å‰ªè—åŒ…å«å›¾ç‰‡çš„ç½‘é¡µ
   - æ£€æŸ¥åç«¯æ¥æ”¶åˆ°çš„ `images` å­—æ®µæ˜¯å¦æ­£ç¡®

3. **æµ‹è¯•é“¾æ¥ä¿¡æ¯ä¼ é€’**:
   - å‰ªè—åŒ…å«é“¾æ¥çš„ç½‘é¡µ
   - æ£€æŸ¥åç«¯æ¥æ”¶åˆ°çš„ `links` å­—æ®µæ˜¯å¦æ­£ç¡®

4. **æµ‹è¯•é£ä¹¦å­˜å‚¨**:
   - ç¡®è®¤æ–°å­—æ®µèƒ½æ­£ç¡®å†™å…¥é£ä¹¦è¡¨æ ¼
   - ç¡®è®¤æ•°æ®æ ¼å¼æ­£ç¡®ï¼ˆåˆ†éš”ç¬¦ã€URLæ ¼å¼ç­‰ï¼‰

---

## å…­ã€å‰ç«¯å·²å®ç°åŠŸèƒ½æ€»ç»“

âœ… **æŒä¹…é«˜äº®åŠŸèƒ½**:
- é«˜äº®ä¼šä¸€ç›´ä¿æŒï¼Œç›´åˆ°å‰ªè—æˆ–ç¦»å¼€é¡µé¢
- å‰ªè—æ—¶ä¼šè‡ªåŠ¨åŒ…å«é«˜äº®ä¿¡æ¯

âœ… **ä¾§è¾¹æ å¯è§†åŒ–**:
- å·²æ·»åŠ é“¾æ¥å±•ç¤ºæ¡†ï¼Œæ˜¾ç¤ºå‰ªè—åˆ°çš„é“¾æ¥
- å·²æ·»åŠ å›¾ç‰‡å±•ç¤ºæ¡†ï¼Œæ˜¾ç¤ºå‰ªè—åˆ°çš„å›¾ç‰‡
- æå‡å¯è§†åŒ–å’Œç»“æ„åŒ–å±•ç¤º

âœ… **æ•°æ®ä¼ é€’**:
- å‰ªè—æ—¶ä¼šå°†å›¾ç‰‡ã€é“¾æ¥ã€é«˜äº®ä¿¡æ¯ä¸€å¹¶ä¼ é€’ç»™åç«¯
- æ•°æ®æ ¼å¼å·²å®šä¹‰åœ¨ `clipper-extension-react/src/types/index.ts` ä¸­

---

## ä¸ƒã€è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·éšæ—¶æ²Ÿé€šï¼

